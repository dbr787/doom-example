#!/bin/bash

# Set DOOM_MODE from metadata if this is the Doom step
if [[ "$BUILDKITE_STEP_KEY" == "run-doom" ]]; then
  export DOOM_MODE=$(buildkite-agent meta-data get "mode")
  echo "Set DOOM_MODE to: $DOOM_MODE"
  
  # In random mode, pre-generate the first move so the game can start immediately
  if [[ "$DOOM_MODE" == "random" ]]; then
    # Random move selection - these match the MOVES array in doom.rb
    moves=("w:Move forward" "s:Move backward" "a:Turn left" "d:Turn right" "Control_L:Fire")
    selected_move=${moves[$RANDOM % ${#moves[@]}]}
    key=$(echo $selected_move | cut -d: -f1)
    
    echo "Pre-generating first random move: $key"
    buildkite-agent meta-data set "key0" "$key"
    buildkite-agent meta-data set "reason0" "Random move generated by pre-command hook"
  fi
fi
